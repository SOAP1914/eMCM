<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<script src="../bower_components/elasticlunr.js/elasticlunr.js"></script>
<dom-module id="my-mcm">
<template>
<style>
@keyframes pulse {
    0% { opacity: 0.1 }
    50% { opacity: 0.5 }
    100% { opacity: 1 }
}

:host > *.target {
    display: block;
    animation: pulse 0.3s linear 0s;
}

</style>
<!-- Display search results -->
<template id="items" is="dom-repeat" items="{{output}}">
    <a name="{{item.ref}}" href="/#{{item.ref}}">
    <div class="section-link row">
        <div class="col-md-8 col-md-offset-2">
            <h2>{{item.parent}} - {{item.title}}</h2>
            <p>{{item.body}}</p>
            <div class="overlay ">
                <h2 class="callout">Explore Section</h2>
            </div>
        </div>
    </div>
    </a>
</template>

<!-- display document content -->
<div id="reader" class="col-md-8">
    <div id="data2"></div>
</div>

<!-- show document footnotes -->
<div id="footnote" class="col-md-4" hidden$="{{hide}}">
    <div id="disc" class="footnote">
        <h2>Discussion</h2>
        <div class="cont">
            No footnote found.<br>
            <a href="#">Request or add on Github</a>
        </div>
    </div>
    <div id="foot" class="footnote">
        <h2>Footnote</h2>
        <div class="cont">
            No footnote found.<br>
            <a href="#">Request or add on Github</a>
        </div>
    </div>
    <div id="annot" class="footnote">
        <h2>Annotation</h2>
        <div class="cont">
            No footnote found.<br>
            <a href="#">Request or add on Github</a></div>
    </div>
</div>

<!-- persist search index to indexeddb -->
<app-indexeddb-mirror log
    key="mcm"
    data="{{_toJSON(raw_index)}}"
    persisted-data="{{index_p}}">
</app-indexeddb-mirror>
</template>

<script>
Polymer({
is: 'my-mcm',
observers: [
        "doSearch(search,dom,index)",
        "_getDom(route,dom)",
            ],
_toJSON : function(e){
    r=e.toJSON();
    r.refMap=e.refMap;
    return r
},
_fromJSON : function(e){
    r=elasticlunr.Index.load(e);
    this.refMap = e.refMap;
    return r;
},
properties: {
    raw_index: {
        type: Object,
        readOnly: false
    },
    index: {
        type: Object,
        readOnly: false,
        notify: true,
        computed: '_fromJSON(index_p)'
    },
    dom: {
        type: Object,
        notify: true
    },
    search: {
        type: String,
    },
    output: {
        type: Array,
        notify: true,
        value: [{title:"Loading index...",ref:"",parent:"Please wait"}],
    },
    refMap: {
        type: Object,
        value: {}
    },
    route: {
        type: String,
        value: ""
    },
    hide: {
        type: Boolean
    }
},
_getDom: function(r1,dom){
      console.log("getDom,",r1)
      var search = r1.path;
      var el = dom.getElementById(search);
      if(!el){
          this._resetPage();
          return;
      }
      this.output=[];
      var myNode = this.$.data2;
      myNode.innerHTML='';
      this.hide=false;
      var el=el.cloneNode(true);
      var d = myNode;
      var elCh = el.querySelectorAll(":scope > section");
      if (!search.startsWith("rule") && !search.startsWith("article") && (el.classList.contains("level1")  || elCh.length!=0)){
          elCh = Array.prototype.slice.call(elCh);
          elCh.forEach(function(e){
              var e2 = e.children[0].cloneNode(true);
              var a = document.createElement("a");
              a.setAttribute("href","#" + e.getAttribute("id"));
              a.appendChild(e2)
              d.appendChild(a);
          });
      } else {
          d.appendChild(el);
      }
      el.querySelectorAll("nav");
  },
  _resetPage: function(){
      this.hide = true;
      window.location.hash="";
      var myNode = this.$.data2;
      myNode.innerHTML='';
  },
  doSearch: function(search,dom,index){
      var res = index.search(search);
      var _this = this;
      this.output = [];
      res.forEach(function(e){
          e.ref = _this.refMap[e.ref];
          var el = dom.getElementById(e.ref);
          _this.push("output",{title:el.children[0].textContent,
                            body:el.children[1].textContent.slice(0,100),
                            parent:el.parentNode.children[0].textContent,
                            ref:e.ref});
        });
        var o = this.output;
        this.output = [];
        this.output = o;
        this._resetPage()
    },

    ready: function() {
        this.importHref("/mcm.html",function(e){
            console.log("imported raw");
            this.dom = e.target.import;
            var _this = this;
            var _data = [];

            function createIndex(){
                console.log("Building Index");
                var res = Polymer.dom(_this.dom).querySelectorAll('section');
                var worker = new Worker("src/service-indexer.js");
                worker.onmessage = function (e) {
                     worker.terminate();
                     if (_this.index){console.log("early index available");
                         _this.output = [];
                         console.log(_this);return;}
                     _data = elasticlunr.Index.load(JSON.parse(e.data))
                     _data.refMap = _this.refMap;
                     _this.output = [];
                     _this.raw_index = _data;
                }
                res.forEach(function(e){
                    if (_this.index){worker.terminate();console.log("really early index available" + e);return false;}
                    var id = e.getAttribute("id")
                    var id2 = Object.keys(_this.refMap).length;
                    _this.refMap[id2]=id;
                    var title = Polymer.dom(e).children[0].textContent;
                    var body = Polymer.dom(e).textContent;
                    worker.postMessage({
                        title : title,
                        body : body,
                        ref : id2,
                    });
                });
                worker.postMessage("done");
            }

            console.log("opening app-mirror");
            request = indexedDB.open("app-mirror");
            request.onerror =
                function(evt){
                console.log("failed");
                createIndex();
                return;
            }
            request.onblocked =
                function(evt){
                console.log("failed");
                createIndex();
                return;
            }
            request.onupgradneeded =
                function(evt){
                console.log("failed");
                createIndex();
                return;
            }
            console.log("waiting for request return");
            request.onerror = function(evt){
                console.log("request fail");
                console.log(evt);
                createIndex();
            };
            request.onsuccess = (function(evt){
                console.log("request success");
                db = this.result;
                console.log(db);
                if (!db.objectStoreNames.contains("mirrored_data")){
                    console.log("no object store");
                    createIndex();
                } else {
                    request3=db.transaction("mirrored_data").objectStore("mirrored_data").get("mcm")
                    request3.onerror = function(evt){
                        console.log("request fail");
                        console.log(evt);
                        createIndex();
                    };
                    request3.onsuccess = function(e){
                        console.log("request3 success");
                        if (!e.target.result){
                            createIndex();return;}
                        _this.index_p = e.target.result;
                        _this.output = [];
                    };
                }
            });

        });
    }
});
</script>
</dom-module>
